<!DOCTYPE html>
<html>
  <meta charset="utf-8"/>
<head>
	<title>Tonejs Midi</title>
	<script type="text/javascript" src="https://unpkg.com/tone@13.4.9/build/Tone.js"></script>
	<script type="text/javascript" src="https://unpkg.com/@tonejs/ui@0.0.8/build/tonejs-ui.js"></script>
	<script type="text/javascript" src="https://unpkg.com/@tonejs/midi"></script>
	<script src="https://d3js.org/d3.v4.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.3/socket.io.min.js"></script>
</head>
<body>
	<style type="text/css">

		#FileDrop{
			position: relative;
			width: 100%;
			height: 100px;
			border: 2px dashed black;
			color: black;
			margin: 20px auto;
		}

		#FileDrop.Hover{
			background-color: black;
			color: white;
		}

		#FileDrop input {
			position: absolute;
			width: 100%;
			height: 100%;
			opacity: 0;
			left: 0px;
			top: 0px;
		}

		#FileDrop #Text {
			position: absolute;
			width: 100%;
			height: 20px;
			line-height: 20px;
			left: 0px;
			top: 50%;
			transform: translate(0, -50%);
			text-align: center;
		}

		textarea {
			font-family: monospace;
			height: 300px;
			width: 100%;
			display: inline-block;
			position: relative;
			float: left;
		}

		#Results {
			position: relative;
			width: 100%;
			margin: 10px auto;
		}

		#Description {
			position: relative;
			width: 100%;
			text-align: center;
			height: 40px;
			font-size: 16px;
			margin: 10px auto;
			font-family: sans-serif;
		}

		tone-play-toggle {
			margin-top: 10px;
		}

	</style>

	<tone-content>
		<div id="Description">MIDI PARTY!</div>
		<div id="player_id"> </div>
		<div id="FileDrop">
			<div id="Text">
				Drop a midi file here
			</div>
			<input type="file" accept="audio/midi">
		</div>
		<div id="Results">
			<textarea id="ResultsText" placeholder="json output..."></textarea>
		</div>
		<tone-play-toggle disabled></tone-play-toggle>
	</tone-content>

  <div class="container" style="text-align:center;"></div>

  <!-- <script type="text/javascript" src="{{ url_for('static', filename='main.js') }}"></script> -->

</body>
</html>
<script>
    // Drag drop box for midi selection
if (!(window.File && window.FileReader && window.FileList && window.Blob)) {
	document.querySelector("#FileDrop #Text").textContent = "Reading files not supported by this browser";
} else {

	const fileDrop = document.querySelector("#FileDrop")

	fileDrop.addEventListener("dragenter", () => fileDrop.classList.add("Hover"))

	fileDrop.addEventListener("dragleave", () => fileDrop.classList.remove("Hover"))

	fileDrop.addEventListener("drop", () => fileDrop.classList.remove("Hover"))

	document.querySelector("#FileDrop input").addEventListener("change", e => {
		//get the files
		const files = e.target.files
		if (files.length > 0){
			const file = files[0]
			document.querySelector("#FileDrop #Text").textContent = file.name
			parseFile(file)
		}
	})
}

let currentMidi = null;
var tempo = 0;

function parseFile(file){
	//read the file
	const reader = new FileReader()
	reader.onload = function(e){
		const midi = new Midi(e.target.result)
		document.querySelector("#ResultsText").value = JSON.stringify(midi, undefined, 2)
		document.querySelector('tone-play-toggle').removeAttribute('disabled')
		currentMidi = midi

		tempo = midi.header.tempos[0].bpm;
	}
	reader.readAsArrayBuffer(file)
}

const synths = []

var svg = d3.select('.container')
.append('svg')
.attr('height', 500)
.attr('width', 1000);

var num_players = 4;
var colors = ['red','blue','green','yellow']

// Black bar hit marker
var marker = svg.append('rect')
.attr('fill', 'black')
.attr('height', num_players * 50)
.attr('width', 3)
.attr('x', 0)
.attr('y', 0);

var markers = [];
var blocks = [];
var notes = [];


// Initialize blocks, notes, and markers
var i = 0;
for (i = 0; i < num_players; i++) {
	markers.push(
		svg.append('rect')
		.attr('fill', colors[i])
		.attr('height', 50)
		.attr('width', 5)
		.attr('x', 0)
		.attr('y', i * 50)
		.style("visibility", "hidden")
	)
	blocks.push([]);
	notes.push([]);
}

// Add blocks based on notes in midi
document.querySelector('tone-play-toggle').addEventListener('play', (e) => {
    socket.emit('toggle_backend_game_state', {"player_number": player_number, "action": e.detail});
});

function start_game(playing)
{
    document.querySelector('tone-play-toggle').playing = playing;

	if (playing && currentMidi){
		const now = Tone.now() + 0.5
		currentMidi.tracks.forEach(function (track, i) {
			//create a synth for each track
			synth = new Tone.PolySynth(10, Tone.Synth, {
				envelope : {
					attack : 0.02,
					decay : 0.1,
					sustain : 0.3,
					release : 1
				}
			}).toMaster()
			synths.push(synth)
			//schedule all of the events
			track.notes.forEach(note => {

				//synth.triggerAttackRelease(note.name, note.duration, note.time + now, note.velocity)

				var random = Math.floor(Math.random() * num_players);

				var block = svg.append('rect')
				.attr('fill', colors[random])
				.attr('height', 15)
				.attr('width', note.duration * 100 - 3)
				.attr('x', note.time * 100)
				.attr('y', 20 + random * 50);

				blocks[random].push(block);
				notes[random].push(note);
			})
		})
	} else {
		//dispose the synth and make a new one
		while(synths.length){
			const synth = synths.shift()
			synth.dispose()
		}
	}

}

function moveBlocks(){
	var i = 0;
	var toRemove = [];
	for (i = 0; i < num_players; i++) {
		blocks[i].forEach(block => {
			block.attr('x', block.attr('x') - 10);//tempo / 600 * (60/tempo*100));

			if (block.attr('x') < 500 && block.attr('x') > -500) {
				block.style("visibility", "visible");
			}
			else {
				block.style("visibility", "hidden");
				//toRemove.push(i);
			}

		})

		// Remove blocks if they pass the x = 0 mark.
		toRemove.forEach(index => {
			//blocks[i].splice(index,1);

		});
	}
}


var interval = setInterval(function(){moveBlocks();}, 100);
var keyPressed = [false,false,false,false];

function play_music(i)
{
    if (!keyPressed[i - 49]){
        markers[i - 49].style("visibility", "visible");
        keyPressed[i - 49] = true;

        var j = 0;
        for (j = 0; j < blocks[i - 49].length; j++){
            var note = notes[i - 49][j];
            var x = parseInt(blocks[i - 49][j].attr('x'));
            var width = parseInt(blocks[i - 49][j].attr('width'));

            if (x <= 0 && x + width > 0){
                synths[0].triggerAttackRelease(note.name, (width - x) / 100);
            }
        }
    }
}


function stop_music(i)
{
    markers[i - 49].style("visibility", "hidden");
    keyPressed[i - 49] = false;
}


</script>
<script>
    var socket = io();
    var keycode = 49; // Number 1

    var player_number = {{ player_number }};
    $("#player_id").html("Player ID: " + player_number);

    $(document).keydown(function(e){

        if (e.keyCode != keycode)
            return;

        console.log(e);
        socket.emit('send_key_press', {"player_number": player_number, "action": "down"});

    });

    $(document).keyup(function(e){

        if (e.keyCode != keycode)
            return;

        socket.emit('send_key_press', {"player_number": player_number, "action": "up"});

    });

    socket.on('get_key_press', function(data){
        console.log(data);
        var player_number = data["player_number"] + 48;
        var action = data["action"];

        if (action == "down")
            play_music(player_number);

        if (action == "up")
            stop_music(player_number)
    });

    socket.on('toggle_frontend_game_state', function(data){
        var action = data["action"];
        start_game(action);
    });

</script>